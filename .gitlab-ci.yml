stages:
  - build

variables: &global-variables
  VERSION: 1.2.0

.image-dotnet: &image-dotnet
  image: mcr.microsoft.com/dotnet/core/sdk:3.1-alpine

.install-build-tools: &install-build-tools
  - apk add zip

.install-github-tools: &install-github-tools
  - apk add jq

.build-win-x64: &build-win-x64
  - "dotnet publish -r win-x64 -c Release -o publish /p:PublishSingleFile=true"

.create-archive: &create-archive
  - "zip -j $INJECTOR_ARCHIVE LICENSE README.md CHANGELOG.md sample-config.ini publish/Injector.exe"

default:
  image: alpine:latest

.job-build-win-x64: &build-win-x64 
  <<: *image-dotnet
  before_script:
    - *install-build-tools
  script: 
    - *build-win-x64
  after_script:
    - *create-archive
  artifacts:
    paths:
      - $INJECTOR_ARCHIVE

master:
  stage: build
  <<: *job-build-win-x64
  only:
    - master  
  variables:
    <<: *global-variables
    INJECTOR_ARCHIVE: injector-$VERSION+$CI_PIPELINE_IID.win64.zip

feature-branch:
  stage: build
  <<: *job-build-win-x64
  only:
    - branches
  except:
    - master
    - test-release-job
  variables:
    <<: *global-variables
    INJECTOR_ARCHIVE: injector-$VERSION+$CI_PIPELINE_IID.$CI_COMMIT_REF_SLUG.win64.zip

.create_changelog_fragment: &create_changelog_fragment  
  - 'fragment_start="## $GITHUB_RELEASE_TAG"'
  - 'fragment_end="## v"'
  - 'sed -n "/^$fragment_start/,/^$fragment_end/ {/^$fragment_start/ {p;n}; /^$fragment_end/ q; p}" CHANGELOG.md >changelog_fragment'

.create_github_release: &update_github_release
  - 'data=$(jq -n --arg tag "$GITHUB_RELEASE_TAG" --arg body "$(cat changelog_fragment)" '"'"'{"tag_name": $tag_name, "body": $body}'"'"')'
  - 'curl -s -H "Authorization: token $GITHUB_API_TOKEN" --data "$data" $GITHUB_API_URL/repos/turkoid/Injector/releases >response'
  - 'upload_url=$(cat response | jq .upload_url)'
  - echo $upload_url

.upload_release_artifacts: &upload_release_artifacts
  - echo hi

release:
  stage: build
  before_script:
    - *install-build-tools
    - *install-github-tools
  script: echo "build and create archive"
  after_script: 
    - *create_changelog_fragment
    - *update_github_release
    - *upload_release_artifacts
  only:
    - test-release-job
  variables:
    <<: *global-variables
    GITHUB_RELEASE_TAG: v1.2.0
    INJECTOR_ARCHIVE: injector-$VERSION+$CI_PIPELINE_IID.win64.zip
    GITHUB_API_URL: https://api.github.com