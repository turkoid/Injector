stages:
  - build

variables: &global-variables
  VERSION: 1.2.0

.build-win-x64: &build-win-x64 
  image: mcr.microsoft.com/dotnet/core/sdk:3.1-alpine
  before_script:
    - apk add zip
  script: 
    - "dotnet publish -r win-x64 -c Release -o publish /p:PublishSingleFile=true"
  artifacts:
    paths:
      - $INJECTOR_ARCHIVE

master:
  stage: build
  only:
    - master
  <<: *build-win-x64
  variables:
    <<: *global-variables
    INJECTOR_ARCHIVE: injector-$VERSION+$CI_PIPELINE_IID.win64.zip

feature-branch:
  stage: build
  <<: *build-win-x64
  only:
    - branches
  except:
    - master
    - test-release-job
  variables:
    <<: *global-variables
    INJECTOR_ARCHIVE: injector-$VERSION+$CI_PIPELINE_IID.$CI_COMMIT_REF_SLUG.win64.zip

release:
  image: alpine:latest
  stage: build
  script: echo "hello world"
  after_script:
    - 'fragment_start="## v1.2.0"'
    - 'fragment_end="## v"'
    - 'sed -n "/^$fragment_start/,/^$fragment_end/ {/^$fragment_start/ {p;n}; /^$fragment_end/ q; p}" >changelog_fragment'
    - echo $changelog_fragment
    - echo $fragment_start
  only:
    - test-release-job